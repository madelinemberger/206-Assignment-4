---
title: "Assignment 4"
author: "Madeline Berger, Sandro Lallas, AnnaClaire Marley"
date: "11/12/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#load necessary packages 

library(tidyverse)
library(vcdExtra)
library(kableExtra)
library(RColorBrewer)
library(car)
library(effsize)
library(kableExtra)
```

Read in the CSVs

```{r}


lobster_size <- read_csv("lobster_size_abundance.csv")
lobster_traps <- read_csv("lobster_traps.csv")
```

The lobster_size file needs to be converted to tidyverse format

```{r}

#convert data to tidyverse
lobster_size1 <- as.data.frame(lobster_size)
lobster_size2 <- expand.dft(lobster_size1, freq = "COUNT") %>% 
  select(YEAR, SITE, SIZE)

lobster_traps1 <- as.data.frame(lobster_traps)
lobster_traps2 <- expand.dft(lobster_traps, freq = "TRAPS")
```

```{r}

#Data wrangling into tables and exploratory graphs

lobster_traps_clean <- lobster_traps %>% 
  select(YEAR, MONTH, SITE, TRAPS) %>% 
  count(SITE, YEAR) %>% 
  filter(SITE== "CARP" | SITE== "MOHK" | SITE== "AQUE" | SITE== "NAPL" | SITE== "IVEE") %>% 
  rename(traps = "n")

traps_summary <- lobster_traps %>% 
  filter(SITE== "CARP" | SITE== "MOHK" | SITE== "AQUE" | SITE== "NAPL" | SITE== "IVEE") %>%
  select(YEAR, MONTH, SITE, TRAPS) %>%
  group_by(SITE,YEAR) %>% 
  summarize(
    traps = sum(TRAPS)
  )

lobster_abundance <- lobster_size %>% 
  select(YEAR, MONTH, SITE, COUNT) %>% 
  count(SITE, YEAR) %>% 
  filter(SITE== "CARP" | SITE== "MOHK" | SITE== "AQUE" | SITE== "NAPL" | SITE== "IVEE") %>% 
  rename(abundance = "n")


trap_plot <- lobster_traps %>% 
  select(YEAR, MONTH, SITE, TRAPS) %>% 
  filter(SITE== "CARP" | SITE== "MOHK" | SITE== "AQUE" | SITE== "NAPL" | SITE== "IVEE") %>% 
  count(SITE, YEAR) %>% 
  ggplot(aes(x = YEAR, y = n)) +
  geom_line(aes(color=SITE)) +
  theme_classic()


trap_plot
  
```


```{r}

#merge cleaned size and abundance data, graph by site
together <- merge(lobster_traps_clean,lobster_abundance, by = c("SITE", "YEAR")) %>% 
  ggplot(aes(x=traps, y=abundance)) +
  geom_col(aes(fill=SITE))+
  facet_wrap(~SITE, scale = "free")

together


# lobster traps across sites
trap_plot <- lobster_traps %>% 
  select(YEAR, MONTH, SITE, TRAPS) %>% 
  filter(SITE== "CARP" | SITE== "MOHK" | SITE== "AQUE" | SITE== "NAPL" | SITE== "IVEE") %>% 
  count(SITE, YEAR) %>% 
  ggplot(aes(x = YEAR, y = n)) +
  geom_line(aes(color=SITE)) +
  theme_classic()


trap_plot

# lobster abundance across sites
abundance_plot <- lobster_size %>% 
  select(YEAR, MONTH, SITE, COUNT) %>% 
  count(SITE, YEAR) %>% 
  filter(SITE== "CARP" | SITE== "MOHK" | SITE== "AQUE" | SITE== "NAPL" | SITE== "IVEE") %>% 
  rename(abundance = "n") %>% 
  ggplot(aes(x = YEAR, y = abundance)) +
  geom_line(aes(color=SITE)) +
  theme_classic()

abundance_plot


#made a different merge for the graph - this way makes sure no data is lost 
size_traps <- full_join(traps_summary, lobster_abundance)

#use new merged data to make side by side line graphs 
size_traps_graph <- ggplot(size_traps, aes(YEAR))+
  geom_line(aes(y=traps, color="traps"))+
  geom_line(aes(y=abundance, color="abundance"))+
  facet_wrap(~SITE)

size_traps_graph


#we should write a statement about what this shows 
#aparently we are also supposed to break these out 
```

2. ANOVA

```{r}

# Compare mean lobster sizes (mm) across five sites for lobster observations collected in 2017

lobster_levene <- leveneTest(SIZE ~ SITE, data = lobster_size2)

lobster_levene

# Variances are not equal

# Can still assume equal variance because largest sample variance is <4x the smallest sample variance, so the variances are close enough (lecture 9)

# ANOVA test for parametric data

# H0: Mean lobster size at the five sites are equal
# HA: At least two means differ significantly

lobster_aov <- aov(SIZE ~ SITE, data = lobster_size2)

summary(lobster_aov)

# At least two samples were taken from populations with different means. Which ones are different? All three different from each other? Or something else?

lob_ph<- TukeyHSD(lobster_aov)

lob_ph

lob_ANOVA <- ggplot(lobster_size2, aes(x = SITE, y = SIZE)) +
  geom_boxplot(fill = "gray", color = "blue") +
  xlab("Site") +
  ylab("Size") +
  theme_bw()
 

lob_ANOVA

```



3. Differences in lobster size between MPAs and nonMPAS in 2012 and 2017  

```{r}
#3: Comparing MPAs v non MPAs between 2012 and 2017 


#create data frames separating MPA sites and nonMPA sites

class(lobster_size2$SIZE)

mpas_2012 <- lobster_size2 %>% 
  filter(SITE == "IVEE" | SITE == "NAPL", YEAR == "2012") %>% 
  mutate(i = row_number()) %>% 
  spread(SITE,SIZE) %>% 
  select(-i)


nonmpas_2012 <- lobster_size2 %>% 
  filter(SITE == "AQUE" | SITE == "CARP" | SITE == "MOHK", YEAR == "2012") %>% 
  mutate(i = row_number()) %>% 
  spread(SITE,SIZE) %>% 
  select(-i)
 
mpas_2017 <- lobster_size2 %>% 
  filter(SITE == "IVEE" | SITE == "NAPL", YEAR == "2017") %>% 
  mutate(i = row_number()) %>% 
  spread(SITE,SIZE) %>% 
  select(-i)

nonmpas_2017 <- lobster_size2 %>% 
  filter(SITE == "AQUE" | SITE == "CARP" | SITE == "MOHK", YEAR == "2017") %>% 
  mutate(i = row_number()) %>% 
  spread(SITE,SIZE) %>% 
  select(-i)
```


```{r}
#create exploratory graphs 

#MPAs, 2012 
hist_mpa2012 <- lobster_size2 %>% 
  filter(SITE == "IVEE" | SITE == "NAPL", YEAR == "2012") %>% 
  ggplot(aes(x=SIZE))+
  geom_histogram(bins = 5)+
  facet_wrap(~SITE)

hist_mpa2012
 

qq_mpa2012 <- lobster_size2 %>% 
  filter(SITE == "IVEE" | SITE == "NAPL", YEAR == "2012") %>% 
  ggplot(aes(sample=SIZE))+
  geom_qq()+
  facet_wrap(~SITE)

qq_mpa2012

#IV does not look normally distributed in 2012
#MPAS 2017

hist_mpa2017 <- lobster_size2 %>% 
  filter(SITE == "IVEE" | SITE == "NAPL", YEAR == "2017") %>% 
  ggplot(aes(x=SIZE))+
  geom_histogram(bins = 5)+
  facet_wrap(~SITE)

hist_mpa2017
 

qq_mpa2017 <- lobster_size2 %>% 
  filter(SITE == "IVEE" | SITE == "NAPL", YEAR == "2017") %>% 
  ggplot(aes(sample=SIZE))+
  geom_qq()+
  facet_wrap(~SITE)

qq_mpa2017


#nonMPAS, 2012

hist_nonmpa2012 <- lobster_size2 %>% 
  filter(SITE == "AQUE" | SITE == "MOHK" | SITE == "CARP", YEAR == "2012") %>% 
  ggplot(aes(x=SIZE))+
  geom_histogram(bins = 10)+
  facet_wrap(~SITE)

hist_nonmpa2012


qq_nonmpa2012 <- lobster_size2 %>% 
  filter(SITE == "AQUE" | SITE == "MOHK" | SITE == "CARP", YEAR == "2012") %>% 
  ggplot(aes(sample=SIZE))+
  geom_qq()+
  facet_wrap(~SITE)
qq_nonmpa2012

#nonMPAS2017


hist_nonmpa2017 <- lobster_size2 %>% 
  filter(SITE == "AQUE" | SITE == "MOHK" | SITE == "CARP", YEAR == "2017") %>% 
  ggplot(aes(x=SIZE))+
  geom_histogram(bins = 10)+
  facet_wrap(~SITE)

hist_nonmpa2017


qq_nonmpa2017 <- lobster_size2 %>% 
  filter(SITE == "AQUE" | SITE == "MOHK" | SITE == "CARP", YEAR == "2017") %>% 
  ggplot(aes(sample=SIZE))+
  geom_qq()+
  facet_wrap(~SITE)

qq_nonmpa2017

```





```{r}
#First Location: IV MPA
#Test variances to determine what kind of t.test we can use

ftest_iv <- var.test(mpas_2012$IVEE,mpas_2017$IVEE)
ftest_iv

#Variances equal, use Student's T Test

ttest_iv <- t.test(mpas_2012$IVEE,mpas_2017$IVEE, var.equal = TRUE)
ttest_iv

#Siglevel = 0.05, no significant difference 

#calculate effect size using Cohen's D

effsize_iv <- cohen.d(mpas_2012$IVEE,mpas_2017$IVEE)
effsize_iv


#Experiment: try Mann Whitney U since data did not appear normal

```

```{r}
#Second Location: Naples MPA
#Test Variances

ftest_naples <- var.test(mpas_2012$NAPL,mpas_2017$NAPL)
ftest_naples

#Use students T test
ttest_naples <- t.test(mpas_2012$NAPL,mpas_2017$NAPL, var.equal = TRUE)
ttest_naples

#No significant difference
#Cohen's d for effect size
effsize_naples <- cohen.d(mpas_2017$NAPL,mpas_2012$NAPL)
effsize_naples

```

```{r}
#Third Location: Carpinteria Non-MPA
#F test

ftest_carp <- var.test(nonmpas_2012$CARP,nonmpas_2017$CARP)
ftest_carp

#Use students T test
ttest_carp <- t.test(nonmpas_2012$CARP,nonmpas_2017$CARP, var.equal = TRUE)
ttest_carp


```

```{r}
#Fourth Location: Arroyo Quemado 
#F Test

ftest_aque <- var.test(nonmpas_2012$AQUE,nonmpas_2017$AQUE)
ftest_aque

#Use students T test

ttest_aque <- t.test(nonmpas_2012$AQUE,nonmpas_2017$AQUE, var.equal = TRUE)
ttest_aque


```

```{r}
#Fifth Location: Mohawk Reef
#FTest

ftest_mohk <- var.test(nonmpas_2012$MOHK,nonmpas_2017$MOHK)
ftest_mohk

#Use students T Test

ttest_mohk <- t.test(nonmpas_2012$MOHK,nonmpas_2017$MOHK, var.equal = TRUE)
ttest_mohk

#Only IV and Mohawk Reef showed a significant difference in lobster size between 2012 and 2017. 

#make table with site rows, each year, traps 
```




4. Proportions of legal lobsters
```{r}

carapace <- lobster_size %>% 
  filter(SIZE != "-99999") %>% 
  select(SITE, SIZE) %>% 
  mutate(Legality = ifelse(SIZE >= 86, "Legal", "Illegal")) %>% 
  count(SITE, Legality) %>% 
  spread(Legality, n) %>% 
  select(-SITE)

rownames(carapace) <- c("AQUE", "CARP", "IVEE", "MOHK", "NAPL")

```




Proprtions of legal groups and table of them:

```{r}
carapace_prop <- prop.table(as.matrix(carapace), 1) %>% 
  round(2)

carapace_prop

carapace_prop_table <- kable(carapace_prop, col.names = c("Illegal","Legal"), align = "c") %>% 
  kable_styling(bootstrap_options = "striped", full_width = F)

carapace_prop_table

```

Chi-square test

```{r}
carapace_x2 <- chisq.test(carapace)
carapace_x2

# X2 = 39.011, df = 4, p value = 6.931e-08
```
The proportion of observed lobsters that were above the legal minimum differed signficantly across all sites ($\chi^2$(`r carapace_x2$parameter`) = `r round(carapace_x2$statistic, 2)`, p value < 0.001).
